<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>抽卡互動網站</title>
  <!-- PeerJS：使用官方 Cloud PeerServer，免後端 -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    :root{
      /* Vibrant clash palette */
      --bg1:#fffaf5; --bg2:#f7fbff; --noise: radial-gradient(1200px 800px at 10% -10%, rgba(255,0,128,.08) 0%, rgba(0,200,255,.06) 35%, transparent 60%);
      --panel:#ffffff; --panel-border: rgba(15,23,42,.08);
      --text:#111827; --muted:#64748b;
      --accent:#ff3ea5; --accent-2:#7c3aed; --accent-3:#ff9f1c; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --ring: rgba(255,62,165,.35);
    }
    *{ box-sizing: border-box; }
    html,body{height:100%}
    body{ margin:0; background: linear-gradient(120deg, var(--bg1), var(--bg2)) fixed; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; }
    body::before{ content:""; position:fixed; inset:0; pointer-events:none; background: var(--noise); opacity:.8; }
    .wrap{ max-width:1100px; margin:0 auto; padding:24px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; }
    h1{ font-size:clamp(22px, 2.4vw, 28px); margin:0; letter-spacing:.5px }
    .sub{ color:var(--muted); font-size:13px }

    .panel{ background:var(--panel); border:1px solid var(--panel-border); border-radius:20px; box-shadow: 0 10px 30px rgba(17,24,39,.06); }
    .controls{ display:grid; grid-template-columns: 1fr 1fr auto auto auto; gap:12px; padding:16px; align-items:center; }
    .controls .group{ display:flex; gap:10px; align-items:center; }

    select, button, input{ appearance:none; background: var(--panel); color:var(--text); border:1px solid var(--panel-border); border-radius:999px; padding:12px 16px; font-size:14px; line-height:1; box-shadow: 0 0 0 0 var(--ring); transition: box-shadow .15s ease, transform .08s ease, border-color .15s ease, opacity .15s ease; }
    select:focus, button:focus, input:focus{ outline:none; box-shadow: 0 0 0 6px var(--ring), 0 0 0 1px rgba(17,24,39,.45) inset; border-color: rgba(17,24,39,.25); }
    button{ cursor:pointer; font-weight:600 }
    .btn-primary{ background: linear-gradient(135deg, var(--accent), #ff7fd1); color:#fff; border-color: transparent; box-shadow: 0 6px 18px rgba(255,62,165,.35); }
    .btn-secondary{ background: linear-gradient(135deg, var(--accent-2), #9d6bff); color:#fff; border-color: transparent; box-shadow: 0 6px 18px rgba(124,58,237,.30); }
    .btn-ok{ background: linear-gradient(135deg, var(--ok), #6ee7b7); color:#0b3b2d; border-color: transparent; box-shadow: 0 6px 18px rgba(16,185,129,.30); }
    .btn-ghost{ background:transparent; border-color: var(--panel-border); }
    button:hover{ transform: translateY(-2px) }
    button:active{ transform: translateY(0) scale(.98) }
    button[disabled]{ opacity:.5; cursor:not-allowed; transform:none; box-shadow:none }

    /* current card */
    .stage{ display:grid; grid-template-columns: 1fr 340px; gap:18px; padding:18px; }
    .card{ border-radius:22px; padding:22px; border:1px solid var(--panel-border); background: radial-gradient(900px 420px at 0% 0%, rgba(255,62,165,.10), transparent), radial-gradient(900px 420px at 100% 100%, rgba(0,200,255,.08), transparent), linear-gradient(180deg, #ffffff, #fffdfb); min-height:220px; display:flex; align-items:center; justify-content:center; text-align:center; position:relative; overflow:hidden; }
    .card .tag{ position:absolute; top:12px; left:12px; font-size:12px; color:var(--muted); background: rgba(255,255,255,.9); border:1px solid var(--panel-border); padding:6px 10px; border-radius:999px }
    .card h2{ margin:10px 0 6px; font-size:22px }
    .card .meta{ color:var(--muted); font-size:13px }
    .card .content{ margin-top:10px; font-size:16px; line-height:1.5 }
    .card img{ max-width:100%; max-height:240px; border-radius:14px; border:1px solid var(--panel-border) }
    .card.pop{ animation: pop .28s ease; }

    .side{ display:grid; gap:10px }
    .stat{ background: #ffffff; border-radius:14px; padding:12px; border:1px solid var(--panel-border); font-size:13px; color:var(--muted) }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#f1f5f9; border:1px solid var(--panel-border); padding:2px 6px; border-radius:6px; font-size:12px; color:#0f172a }

    /* confirmed grid */
    .confirmed{ margin-top:18px; padding:16px }
    .grid{ display:grid; grid-template-columns: repeat( auto-fill, minmax(210px,1fr) ); gap:14px; }
    .mini{ background: linear-gradient(180deg, #ffffff, #fffdfa); border:1px solid var(--panel-border); border-radius:16px; padding:12px; position:relative; box-shadow:0 8px 20px rgba(17,24,39,.06) }
    .mini .t{ font-weight:700; font-size:14px }
    .mini .m{ color:var(--muted); font-size:12px }
    .mini img{ width:100%; height:120px; object-fit:cover; border-radius:12px; border:1px solid var(--panel-border); margin-top:8px }
    .mini .del{ position:absolute; top:8px; right:8px; border:0; background: linear-gradient(135deg, #ff6b6b, #ff8fa3); color:#fff; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:0 6px 16px rgba(239,68,68,.25) }

    @keyframes pop{ 0%{ transform: scale(.92); opacity:0 } 100%{ transform: scale(1); opacity:1 } }

    @media (max-width: 900px){ .stage{ grid-template-columns: 1fr } }
    @media (max-width: 640px){ .controls{ grid-template-columns: 1fr; } }


    /* 大卡顏色（抽卡區） */
.card.體驗卡 { background: linear-gradient(180deg, #fff5f5, #ffeaea); border-color: #ffb3b3; }
.card.遊戲卡 { background: linear-gradient(180deg, #f5f9ff, #e5f0ff); border-color: #99c2ff; }
.card.科技卡 { background: linear-gradient(180deg, #f5fff8, #e5ffe9); border-color: #9ef5b6; }
.card.GPT卡 { background: linear-gradient(180deg, #fffaf5, #fff0e0); border-color: #ffd699; }

/* 小卡顏色（已確認區） */
.mini.體驗卡 { background: linear-gradient(180deg, #fff5f5, #ffeaea); border-color: #ffb3b3; }
.mini.遊戲卡 { background: linear-gradient(180deg, #f5f9ff, #e5f0ff); border-color: #99c2ff; }
.mini.科技卡 { background: linear-gradient(180deg, #f5fff8, #e5ffe9); border-color: #9ef5b6; }
.mini.GPT卡 { background: linear-gradient(180deg, #fffaf5, #fff0e0); border-color: #ffd699; }

    /* Peer ID badge */
    #peerIdBadge{ position:fixed;right:12px;bottom:12px;background:#fff;border:1px solid var(--panel-border);box-shadow:0 8px 20px rgba(17,24,39,.06);border-radius:10px;padding:8px 10px;font-size:12px;color:#475569;z-index:9999;display:none }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>抽卡互動網站（PeerJS 全員互看版）</h1>
        <div class="sub">一次抽一張，不滿意可重抽；按下「確認」後卡片會固定顯示於下方結果區。全員互看，主持人頁面需保持開啟。</div>
      </div>
      <button id="btnReset" class="btn-ghost" title="清空結果並重置">重置</button>
    </header>

    <section class="panel controls" aria-label="控制區">
      <div class="group">
        <label for="topicSelect">主題：</label>
        <select id="topicSelect" aria-label="選擇主題">
          <option value="" selected disabled>請選擇主題</option>
        </select>
      </div>
      <div class="group">
        <label for="categorySelect">分類：</label>
        <select id="categorySelect" aria-label="選擇分類" disabled>
          <option value="" selected disabled>請先選主題</option>
        </select>
      </div>

      <!-- 房間 / 角色（PeerJS） -->
      <div class="group" style="min-width:280px">
        <label for="roomId">房間ID：</label>
        <input id="roomId" placeholder="例如：workshop-001" style="flex:1; min-width:160px; padding:10px;border:1px solid var(--panel-border);border-radius:10px">
      </div>
      <div class="group">
        <label><input type="checkbox" id="isHost"> 我是主持人</label>
      </div>
      <button id="btnJoin" class="btn-ghost" title="加入/建立房間">加入房間</button>

      <button id="btnDraw" class="btn-primary" disabled>抽卡（Space）</button>
      <button id="btnReroll" class="btn-secondary" disabled>再抽一次（R）</button>
      <button id="btnConfirm" class="btn-ok" disabled>確認（Enter）</button>
    </section>

    <section class="panel stage">
      <div id="currentCard" class="card" role="status" aria-live="polite" aria-atomic="true" data-empty="true">
        <div class="content">尚未抽卡，點擊「抽卡」開始</div>
      </div>
      <aside class="side">
        <div class="stat">共 <span id="statTopics">0</span> 個主題、<span id="statCategories">0</span> 個分類、<span id="statCards">0</span> 張卡可抽。</div>
        <div class="stat">鍵盤快捷鍵：<span class="kbd">Space</span> 抽卡、<span class="kbd">R</span> 再抽、<span class="kbd">Enter</span> 確認。</div>
        <div class="stat">避免重複：<input type="checkbox" id="chkNoRepeat" /> <label for="chkNoRepeat">在本場次內盡量不重複（抽完所有卡後才允許重複）</label></div>
      </aside>
    </section>

    <section class="panel confirmed" aria-label="結果區">
      <h3 style="margin:0 0 8px 0; font-size:16px; color:#cbd5e1">已確認的卡片</h3>
      <div id="confirmedGrid" class="grid"></div>
    </section>



  <!-- 顯示我的 Peer ID（主持人分享給大家） -->
  <div id="peerIdBadge">
    <div>我的ID：<span id="myPeerId"></span></div>
    <div style="margin-top:6px;font-size:11px;color:#475569">
      <b>成員：</b>
      <ul id="peerList" style="padding-left:18px;margin:4px 0 0 0;max-height:120px;overflow:auto;"></ul>
    </div>
  </div>

  <script>
  /**
   * === 可編輯資料（Workshop 主持人可在此區客製化） ========================
   * 結構：topics -> categories -> cards[]
   * 4 個主題 × 每主題 4 分類 × 每分類 10 張卡 牌卡
   */
 const TOPICS = ["體驗卡", "遊戲卡", "科技卡", "GPT卡"];

// 每個主題對應自己的分類清單
const CATS_BY_TOPIC = {
  "體驗卡": ["A. 城市故事探索組", "B. 微移動互動組", "C. 城市社群互動組", "D. 感官與時空組", "隨機"],
  "遊戲卡": ["時空變數類", "獎勵與成就類", "社群與互動類", "感受與表達類", "隨機"],
  "科技卡": ["A GAI / Agent", "B GAI / Agent"],
  "GPT卡": ["隨機"] // 這就是 Topic D 的唯一分類
};

const DATA = { topics: {} };

for (const t of TOPICS){
  DATA.topics[t] = {};
  for (const c of CATS_BY_TOPIC[t]){
    // Topic D：放入你指定的 10 張卡
    if (t === "GPT卡"){
      DATA.topics[t][c] = [
        { text: `1.靈感暖身引導者
我抽到的地點是【】，交通方式是【】，請幫我想一個旅程的故事開場情境。不要寫整段行程，只給我一段情境開頭。` },
        { text: `2互動任務設計師
我抽到的技術卡是【】，遊戲卡是【】，請幫我設計一個玩家在【地點】可以完成的互動任務。任務可以是拍照、打卡、收集、分享等。` },
        { text: `3.體驗節點創造者
我選的的地點是【】，請幫我想一個「體驗節點」概念，這裡可能會發生什麼事情？結合我手上的技術卡【】與遊戲卡【】。` },
        { text: `4.故事接龍接棒員
上一位玩家的故事是【】，接下來的地點是【】，請幫我接一段新的故事情節，只要開頭，不需要完整故事，讓我來收尾。` },
        { text: `5.風格導向提案者
我希望這段旅程是【療癒／驚喜／挑戰性／浪漫】風格，地點是【】，交通卡是【】，請給我一個符合這種情緒的旅程主題設定。` },
        { text: `6.共享設計引導員
我想把這段旅程設計成多人共騎／互相幫助的形式。請根據【技術卡】與【遊戲卡】，提供一種共享行程的設計方式。` },
        { text: `7.任務升級挑戰者
我想讓這段行程變成一個完整挑戰任務，請根據【地點】與【技術卡】，提供一個三階段的任務流程設計，包含起點、行動與結尾。` },
        { text: `8.轉折事件創造者
這段旅程看起來太順利了。請幫我在【地點】設計一個「意外事件」，可能是人、環境或突發任務，增加旅程挑戰性。` },
        { text: `9.點子變現提示家
我設計了一個微旅行行程，包含【摘要點子或任務】。請幫我思考這個點子要怎麼變成一個可以持續運作的服務？可以跟誰合作？有哪些收入、交換或永續的方式？` },
        { text: `10.結尾設計規劃師
這趟旅程到了尾聲，我想留下某種「紀錄或行動延伸」。請根據【技術卡】與【遊戲卡】設計一個結尾任務或回饋方式。
例如生成一張碳紀錄卡、照片牆或參與排行榜。` },
      ];
    }
    // Topic A / Category 1：放入你提供的中文卡
    else if (t === "體驗卡" && c === "A. 城市故事探索組"){
      DATA.topics[t][c] = [
        { text: "1.歷史時間軸路線\n以城市歷史演變串連舊街與新區，體驗時空轉換。" },
        { text: "2.夜景微旅行\n夜晚限定的燈光與景觀探索體驗。" },
        { text: "3.城市聲音散步\n收集聲音景觀建立聲音地圖。" },
        { text: "4.故事導向解謎\n透過劇情線索實境解謎。" },
        { text: "5.文化地標連結\n串連文化地標路線任務。" },
        { text: "6.影視場景巡禮\n拍攝景點巡禮體驗。" },
        { text: "7.在地人物訪談\n與居民互動收集故事。" },
        { text: "8.城市節慶快閃\n節慶短期限定探索。" },
        { text: "9.地方美食鏈結\n美食為主題的探索路線。" },
        { text: "10.公共藝術巡禮\n收集公共藝術作品並拍照分享。" },
      ];
    }

    // Topic A / Category 2：放入你提供的中文卡
        else if (t === "體驗卡" && c === "B. 微移動互動組"){
      DATA.topics[t][c] = [
        { text: "1.速度對比\n結合快（滑板車）與慢（步行）的路線。" },
        { text: "2.坡道與高差體驗\n體驗坡道與高差的挑戰。" },
        { text: "3.單車環線\n環狀單車探索路線。" },
        { text: "4.多模式轉換\n公共交通+微移動串連探索。" },
        { text: "5.低碳挑戰\n累積碳減量積分。" },
        { text: "6.隱藏巷弄探索\n尋找隱密小徑捷徑。" },
        { text: "7.停留點微互動\n路線停留點的快速互動體驗。" },
        { text: "8.共享車站遊戲化\n共享車站的遊戲化挑戰。" },
        { text: "9.微距離比拼\n不同人完成同距離比賽。" },
        { text: "10.能源積分挑戰\n依里程累積能源積分兌換。" },
      ];
    }
    // Topic A / Category 3：放入你提供的中文卡
    else if (t === "體驗卡" && c === "C. 城市社群互動組"){
      DATA.topics[t][c] = [
        { text: "1.社群合力任務\n多人協作完成挑戰。" },
        { text: "2.居民互動體驗\n與店家/居民互動。" },
        { text: "3.合作攝影挑戰\n團隊分工拍攝不同主題。" },
        { text: "4.社區故事共創\n蒐集居民故事進行共創。" },
        { text: "5.城市志工行動\n探索過程中的公益行為。" },
        { text: "6.文化交流活動\n與不同背景者交換體驗。" },
        { text: "7.臨時集會任務\n即時通知集合挑戰。" },
        { text: "8.共享地圖編輯\n玩家共同標註特色地點。" },
        { text: "9.社區貢獻排名\n將貢獻轉化為排名與成就。" },
        { text: "10.現場音樂會串聯\n音樂活動與社群互動結合。" },
      ];
    }
    // Topic A / Category 4：放入你提供的中文卡
    else if (t === "體驗卡" && c === "D. 感官與時空組"){
      DATA.topics[t][c] = [
        { text: "1.早晨市場任務\n清晨市場探索與紀錄。" },
        { text: "2.黃昏散步線\n黃昏限定慢觀察。" },
        { text: "3.夜間挑戰\n體驗夜間微移動。" },
        { text: "4.雨天替代路線\n雨天限定庇護點探索。" },
        { text: "5.感官覺察挑戰\n紀錄聲音、氣味、色彩與觸覺。" },
        { text: "6.速度切換體驗\n指定區域快走/慢觀察。" },
        { text: "7.即時事件觸發\n城市事件改變路線。" },
        { text: "8.季節路線更新\n季節差異動態探索。" },
        { text: "9.時間旅行體驗\n結合科技還原歷史未來場景。" },
        { text: "10.全城慢活日\n推動全市低速體驗日。" },
      ];
    }
    else if (t === "體驗卡" && c === "隨機"){
      // Category 5 = Category 1~4 所有卡合併
      let combined = [];
      ["A. 城市故事探索組", "B. 微移動互動組", "C. 城市社群互動組", "D. 感官與時空組"].forEach(catName => {
        if (DATA.topics["體驗卡"][catName]) {
          combined = combined.concat(DATA.topics["體驗卡"][catName]);
        }
      });
      DATA.topics[t][c] = combined;
    }

    // Topic B / Category A：放入你提供的中文卡
    else if (t === "遊戲卡" && c === "時空變數類"){
      DATA.topics[t][c] = [
        { text: "1.即時任務 (Real-time)\n需要立即完成的任務，例如「3分鐘內找到指定景點」。" },
        { text: "2.延遲觸發 (Delayed)\n任務需等待特定時間後才可解鎖，例如「明日早晨可再挑戰下一站」。" },
        { text: "3.循環週期 (Cyclic)\n每日、每週、季節性重複出現的任務，例如「春季限定路線」。" },
        { text: "4.歷史時間軸 (Historical Timeline)\n任務設定於特定歷史背景，例如「AR還原古城」。" },
        { text: "5.未來情境 (Speculative Future)\n模擬未來城市的體驗，例如「2050智慧街道」。" },
        { text: "6.微縮範圍 (Micro-scale)\n小尺度任務，例如「一條老街或市場」。" },
        { text: "7.擴張範圍 (Expanded Scale)\n跨行政區或多城市連結的探索。" },
        { text: "8.層疊空間 (Layered Space)\n結合地面、地下與建築內外的任務。" },
        { text: "9.虛實疊加 (Physical + Virtual)\n實體場景與虛擬地圖交錯，例如「虛擬 NPC 出現在實體公園」。" },
        { text: "10.快節奏 (Fast-paced)\n限時衝刺任務，例如「5分鐘內蒐集三個點位」。" },
        { text: "11.慢體驗 (Slow Experience)\n鼓勵停留與觀察，例如「坐下觀察10分鐘並素描」。" },
        { text: "12.動態切換 (Dynamic Switching)\n在快與慢之間切換，例如「先衝到下一站，再慢觀察」。" },
      ];
    }

    // Topic B / Category B：放入你提供的中文卡
    else if (t === "遊戲卡" && c === "獎勵與成就類"){
      DATA.topics[t][c] = [
        { text: "1.獎勵計劃\n提供點數、獎品、升級的時間架構與交付機制" },
        { text: "2.成就\n完成任務後的象徵性標記（虛擬或實體）。" },
        { text: "3.成就徽章\n用於象徵特定成就的徽章系統。" },
        { text: "4.里程碑\n將重大進度設為明顯的成就標記。" },
        { text: "5.收藏系統\n鼓勵蒐集特定物品或標記。" },
        { text: "6.免費午餐\n因他人努力而獲得額外好處。" },
        { text: "7.抽獎\n完全由運氣決定勝負，製造期待感。" },
        { text: "8.隨機獎勵\n不可預測的獎勵增加驚喜與期待。" },
        { text: "9.習慣培養\n鼓勵重複行為形成習慣。" },
        { text: "10.回歸誘因\n讓玩家願意再次回來參與活動。" },
      ];
    }
    // Topic B / Category C：放入你提供的中文卡
    else if (t === "遊戲卡" && c === "社群與互動類"){
      DATA.topics[t][c] = [
        { text: "1.社群發現\n動員整個社群共同解開挑戰。" },
        { text: "2.合作任務\n鼓勵團隊合作完成目標。" },
        { text: "3.交換交易\n鼓勵玩家之間交換資源。" },
        { text: "4.遊戲的社會紋理\n遊戲促進人際關係與信任感。" },
        { text: "5.病毒式遊戲機制\n在多人參與下效果最佳的遊戲元素。" },
        { text: "6.微型排行榜\n小群體的排名比較，製造競爭氛圍。" },
        { text: "7.地位\n小群體的排名比較，製造競爭氛圍。" },
      ];
    }
    // Topic B / Category D：放入你提供的中文卡
    else if (t === "遊戲卡" && c === "感受與表達類"){
      DATA.topics[t][c] = [
        { text: "1.角色自訂\n玩家可自訂角色或外觀風格。" },
        { text: "2.自我表達\n允許玩家創造或展示個人內容。" },
        { text: "3.敘事驅動\n使用故事情節引導遊戲進程。" },
        { text: "4.史詩意義\n讓玩家覺得自己是重要目標的一部分。" },
        { text: "5.增幅器\n可影響其他行動結果的物品。" },
        { text: "6.虛擬物品\n遊戲過程中的數位獎勵或收藏品。" },
        { text: "7.輪替式實體獎勵\n符合條件即可獲得的實體獎品，條件會輪替。" },
        { text: "8.擁有權\n控制某樣東西並視為個人財產。" },
        { text: "9.跨平台遊戲\n可在多平台間無縫體驗。" },
        { text: "10.隱私\n資訊控制與分享的自由度。" },
        { text: "11.進度動態\n清楚顯示任務與成就進展。" },
      ];
    }
    else if (t === "遊戲卡" && c === "隨機"){
      // Category 5 = Category 1~4 所有卡合併
      let combined = [];
      ["時空變數類", "獎勵與成就類", "社群與互動類", "感受與表達類"].forEach(catName => {
        if (DATA.topics["遊戲卡"][catName]) {
          combined = combined.concat(DATA.topics["遊戲卡"][catName]);
        }
      });
      DATA.topics[t][c] = combined;
    }

    // Topic C / Category A：放入你提供的中文卡
    else if (t === "科技卡" && c === "A GAI / Agent"){
      DATA.topics[t][c] = [
        { text: "1.全能地方改造 Image GAI\n將現實街景轉換成使用者想像的城市樣貌，像是童話城、未來市或森林小徑" },
        { text: "2.反思人地關係 Image GAI Text GAI\n透過增加或刪除街景中的要素，反思對城市的印象" },
        { text: "3.時光機 Image GAI\n讓使用者穿越至城市的過去或未來，進入特定時代的風格場景中" },
        { text: "4.多重宇宙 Image GAI\n於所在城市的各種主題版本間來回穿梭。這些版本中的人事物都跟現實城市有所對應，但風格不同" },
        { text: "5.陌異化 Image GAI\n生成與現實相似但略有不同的、帶有既視感的「平行時空城市」。" },
        { text: "6.奇異街景拼貼 Image GAI\n以異想天開、反物理邏輯的方式改造城市空間" },
        { text: "7.接龍共創 Image GAI\n邀請人們即興輪流創造元素。前個人生成的內容可以成為下一個人生成創作的基礎" },
        { text: "8.呼朋引伴 Text GAI\n可呼叫虛擬夥伴或其他使用者，一起完成團體旅程或任務" },
        { text: "9.變身角色 Text GAI\n根據場域變換角色身分（如孩童、老者、藝術家）提供行程體驗角度" },
        { text: "10.導航探索 Text GAI\n根據你的偏好即時推薦地點與行程，像智慧個人化導航助手" },
        { text: "11.思維覺醒 Text GAI\n運用AI讓角色的性格隨著時間與空間的變化產生轉變" },
        { text: "12.做夢 Image GAI\n生成與夢境有所呼應的超現實內容，創造潛意識、內在世界與城市的連結" },
        { text: "13.模糊化 Image GAI Text GAI\n將一人的訊息模糊化或去除個資後傳給另一人" },
        { text: "14.加密與解密 Text GAI\n將一人的原始訊息以另一種形式呈現給特定的人，使他們更易理解或更難理解訊息" },
        { text: "15.漸變串聯 Video GAI Image GAI\n將看似無關的不同情境以漸變的方式關聯起來" },
        { text: "15.道聽塗說 Image GAI Text GAI\n會提供錯誤的、帶偏見的在地資訊，促使了解在地的人們糾正資訊" },
        { text: "16.自定義 ? GAI\n依據你對某種 GAI 的了解，將它的互動特徵結合到微移動體驗" },
      ];
    }
        // Topic C / Category B：放入你提供的中文卡
        else if (t === "科技卡" && c === "B GAI / Agent"){
      DATA.topics[t][c] = [
        { text: "1.地標悄悄話 LLM + Location-based Dialogue System\n在城市地標植入語音助理，僅在使用者接近時觸發，提供即時、超在地、具趣味或實用的資訊。" },
        { text: "2.聲音導航 Multi-modal AI (vision + audio fusion), spatial memory building, path planning\n透過視覺與聲音訊號建構空間記憶，使用多模態 AI 導航至聲音來源。" },
        { text: "3.聲音地圖 Multi-modal sensing (vision + acoustics), 3D environment simulation, deep reinforcement learning\n在 3D 現實世界中，AI 能同時「看」和「聽」，藉由回響與聲源辨識找路。" },
        { text: "4.共創氛圍Human-AI co-creation, spatial audio design, multi-step interaction pipeline\n透過步驟與參與者共同創造沉浸式空間音效，而非黑盒子式的生成。" },
        { text: "5.提示音Acoustic design, environmental noise analysis\n為電動滑板車設計提示音，使其在各種噪音環境下被感知而不刺耳。" },
        { text: "6.環境音Urban soundscape analysis, sensory impact research, mobility device sound design\n探討微移動如何改變城市的感官地景，特別是低噪音電動工具對行人與視障者的影響。" },
      ];
    }
    // 其他主題 / 分類：維持原本每分類 10 張卡
    else {
      DATA.topics[t][c] = [];
      for (let i = 1; i <= 10; i++){
        DATA.topics[t][c].push({ text: `${t} · ${c} · Card ${String(i).padStart(2,'0')}` });
      }
    }
  }
}

  /**
   * === 程式邏輯 ===========================================================
   */
  // 先收集 DOM
  const els = {
    topicSelect: document.getElementById('topicSelect'),
    categorySelect: document.getElementById('categorySelect'),
    btnDraw: document.getElementById('btnDraw'),
    btnReroll: document.getElementById('btnReroll'),
    btnConfirm: document.getElementById('btnConfirm'),
    btnReset: document.getElementById('btnReset'),
    currentCard: document.getElementById('currentCard'),
    confirmedGrid: document.getElementById('confirmedGrid'),
    statTopics: document.getElementById('statTopics'),
    statCategories: document.getElementById('statCategories'),
    statCards: document.getElementById('statCards'),
    chkNoRepeat: document.getElementById('chkNoRepeat'),
    testResults: document.getElementById('testResults')
  };

  // 建立 topic / category 選單
  const topicNames = Object.keys(DATA.topics);
  for (const t of topicNames){
    const opt = document.createElement('option');
    opt.value = t; opt.textContent = t; els.topicSelect.appendChild(opt);
  }
  function populateCategories(topic){
    els.categorySelect.innerHTML = '<option value="" selected disabled>請選擇分類</option>';
    if (!topic){ els.categorySelect.disabled = true; return; }
    for (const c of Object.keys(DATA.topics[topic])){
      const opt = document.createElement('option');
      opt.value = c; opt.textContent = c; els.categorySelect.appendChild(opt);
    }
    els.categorySelect.disabled = false;
  }
  function updateDrawEnabled(){
    const ready = !!els.topicSelect.value && !!els.categorySelect.value;
    els.btnDraw.disabled = !(ready && current === null);
  }
  els.topicSelect.addEventListener('change', () => {
    populateCategories(els.topicSelect.value);
    current = null; clearCurrentUI();
    updateDrawEnabled();
  });
  els.categorySelect.addEventListener('change', () => { current = null; clearCurrentUI(); updateDrawEnabled(); });

  // 統計
  const stats = (() => {
    let categories = 0, cards = 0;
    for (const t of Object.values(DATA.topics)){
      for (const cat of Object.values(t)){
        categories += 1; cards += cat.length;
      }
    }
    return { topics: topicNames.length, categories, cards };
  })();
  els.statTopics.textContent = String(stats.topics);
  els.statCategories.textContent = String(stats.categories);
  els.statCards.textContent = String(stats.cards);

  // 內部狀態
  let current = null; // {topic, category, card}
  const confirmed = []; // push {uid, topic, category, idx, card}

  // anti-repeat 用池
  const seenPool = new Set(); // key: `${topic}|${category}|${idx}`

  function randomPick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

  function getKeysFor(topic, category){
    const out = [];
    const list = DATA.topics[topic]?.[category] || [];
    list.forEach((_, idx) => out.push({ topic, category, idx }));
    return out;
  }

  function pickCard(topic, category){
    const noRepeat = els.chkNoRepeat.checked;
    const keys = getKeysFor(topic, category);
    const candidates = noRepeat ? keys.filter(k => !seenPool.has(`${k.topic}|${k.category}|${k.idx}`)) : keys;
    const pool = candidates.length ? candidates : keys; // 若抽盡，允許重複
    const { topic: t, category: c, idx } = randomPick(pool);
    const card = DATA.topics[t][c][idx];
    if (noRepeat) seenPool.add(`${t}|${c}|${idx}`);
    return { topic: t, category: c, idx, card };
  }

  function renderCurrent(cardState){
  const box = els.currentCard;
  box.innerHTML = '';
  box.removeAttribute('data-empty');

  // 清除舊的 Topic 樣式
  box.classList.remove('體驗卡','遊戲卡','科技卡','GPT卡');
  // 根據 Topic 加顏色
  if (cardState.topic === "體驗卡") box.classList.add('體驗卡');
  if (cardState.topic === "遊戲卡") box.classList.add('遊戲卡');
  if (cardState.topic === "科技卡") box.classList.add('科技卡');
  if (cardState.topic === "GPT卡") box.classList.add('GPT卡');

  const tag = document.createElement('div'); tag.className = 'tag'; tag.textContent = `${cardState.topic} · ${cardState.category}`;
  const title = document.createElement('h2'); title.textContent = cardState.card.text ? '' : '';
  const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = '';

  const content = document.createElement('div'); content.className = 'content';
  if (cardState.card.text){
    content.textContent = cardState.card.text;
  } else if (cardState.card.image){
    const img = document.createElement('img'); img.src = cardState.card.image; img.alt = cardState.card.caption || '抽卡圖片'; img.loading = 'lazy';
    content.appendChild(img);
    if (cardState.card.caption){
      const cap = document.createElement('div'); cap.style.marginTop = '6px'; cap.style.fontSize = '13px'; cap.style.color = '#cbd5e1'; cap.textContent = cardState.card.caption; content.appendChild(cap);
    }
  }

  box.appendChild(tag); box.appendChild(title); box.appendChild(meta); box.appendChild(content);

  box.classList.add('pop');
  box.addEventListener('animationend', () => box.classList.remove('pop'), { once:true });

  els.btnDraw.disabled = true;
  els.btnReroll.disabled = false; 
  els.btnConfirm.disabled = false;
}

  function renderConfirmed(){
    els.confirmedGrid.innerHTML = '';
    for (const item of confirmed){
      const card = document.createElement('div'); 
card.className = 'mini'; 
card.dataset.uid = String(item.uid || '');

// 根據 Topic 加顏色
if (item.topic === "體驗卡") card.classList.add('體驗卡');
if (item.topic === "遊戲卡") card.classList.add('遊戲卡');
if (item.topic === "科技卡") card.classList.add('科技卡');
if (item.topic === "GPT卡") card.classList.add('GPT卡');
      const t = document.createElement('div'); t.className = 't'; t.textContent = `${item.topic} · ${item.category}`;
      const m = document.createElement('div'); m.className = 'm'; m.textContent = item.card.text ? '' : '';

      // 刪除按鈕
      const del = document.createElement('button');
      del.type = 'button'; del.className = 'del'; del.dataset.uid = String(item.uid || '');
      del.setAttribute('aria-label', '刪除這張已確認的卡片');
      del.title = '刪除'; del.textContent = '刪除';

      card.appendChild(del);
      card.appendChild(t); card.appendChild(m);
      if (item.card.text){
        const p = document.createElement('div'); p.style.marginTop = '6px'; p.textContent = item.card.text; card.appendChild(p);
      } else if (item.card.image){
        const img = document.createElement('img'); img.src = item.card.image; img.alt = item.card.caption || '抽卡圖片'; img.loading = 'lazy'; card.appendChild(img);
        if (item.card.caption){
          const cap = document.createElement('div'); cap.style.marginTop = '6px'; cap.style.fontSize = '12px'; cap.style.color = '#cbd5e1'; cap.textContent = item.card.caption; card.appendChild(cap);
        }
      }
      els.confirmedGrid.appendChild(card);
    }
  }

  function clearCurrentUI(){
    els.currentCard.setAttribute('data-empty', 'true');
    els.currentCard.innerHTML = '<div class="content">尚未抽卡，點擊「抽卡」開始</div>';
    els.btnReroll.disabled = true; 
    els.btnConfirm.disabled = true;
  }

  // 事件
  els.btnDraw.addEventListener('click', () => {
    const t = els.topicSelect.value;
    const c = els.categorySelect.value;
    if (!t || !c) return;
    if (current) return;
    current = pickCard(t, c);
    renderCurrent(current);
  });

  els.btnReroll.addEventListener('click', () => {
    if (!current) return;
    const t = els.topicSelect.value;
    const c = els.categorySelect.value;
    if (!t || !c) return;
    current = pickCard(t, c);
    renderCurrent(current);
  });

  els.btnConfirm.addEventListener('click', () => {
    if (!current) return;
    // 產生唯一識別碼
    const uid = Date.now().toString(36) + Math.random().toString(36).slice(2,8);
    confirmed.push({ ...current, uid });
    renderConfirmed();
    current = null; 
    clearCurrentUI();
    updateDrawEnabled();
  });

  // 已確認卡片刪除（事件委派）
  els.confirmedGrid.addEventListener('click', (e) => {
    const btn = e.target.closest('button.del');
    if (!btn) return;
    const uid = btn.dataset.uid;
    const i = confirmed.findIndex(x => String(x.uid) === String(uid));
    if (i !== -1){
      confirmed.splice(i, 1);
      renderConfirmed();
    }
  });

  els.btnReset.addEventListener('click', () => {
    if (!confirm('確定要清空目前結果並重置嗎？')) return;
    confirmed.splice(0); renderConfirmed();
    current = null; clearCurrentUI();
    seenPool.clear();
    updateDrawEnabled();
  });

  // 快捷鍵：Space 抽卡、R 再抽、Enter 確認（含簡易節流）
  let keyLock = false;
  window.addEventListener('keydown', (e) => {
    if (keyLock) return;
    if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    if (e.code === 'Space'){ e.preventDefault(); keyLock = true; els.btnDraw.click(); setTimeout(()=>keyLock=false, 120); }
    if ((e.key||'').toLowerCase() === 'r'){ keyLock = true; els.btnReroll.click(); setTimeout(()=>keyLock=false, 120); }
    if (e.key === 'Enter'){ keyLock = true; els.btnConfirm.click(); setTimeout(()=>keyLock=false, 120); }
  });

  // === 測試（不影響實際狀態） ==============================================
 
  </script>

  <!-- =================== PeerJS「全員互看」同步補丁 =================== -->
  <script>
  // 額外顯示我的 Peer ID（方便主持人分享）已在 HTML 建立 #peerIdBadge
  const elsNet = {
    roomId: document.getElementById('roomId'),
    isHost: document.getElementById('isHost'),
    btnJoin: document.getElementById('btnJoin'),
    myPeerId: document.getElementById('myPeerId'),
    badge: document.getElementById('peerIdBadge'),
    peerList: document.getElementById('peerList'),
  };

  let peer, myId = null;
  const conns = new Set(); // Host: 所有客戶端
  let hostConn = null;     // Guest: 連主持人
  let hostId = null;       // Guest: 主持人 ID

  function createPeer(idHint){ return new Peer(idHint || undefined, { debug: 1 }); }
  function broadcast(msg){ for (const c of conns){ try{ c.open && c.send(msg); }catch(_){ } } }
  function sendToHost(msg){ if (hostConn && hostConn.open){ try{ hostConn.send(msg); }catch(_){ } } }

  function getSnapshot(){
    return {
      confirmed,
      seen: Array.from(seenPool),
      topic: els.topicSelect.value,
      category: els.categorySelect.value,
      noRepeat: els.chkNoRepeat.checked
    };
  }
  function applySnapshot(s){
    if (!s) return;
    confirmed.splice(0); confirmed.push(...(s.confirmed||[]));
    seenPool.clear(); (s.seen||[]).forEach(k=>seenPool.add(k));
    if (s.topic && DATA.topics[s.topic]){ els.topicSelect.value = s.topic; populateCategories(s.topic); }
    if (s.category && DATA.topics[s.topic]?.[s.category]){ els.categorySelect.value = s.category; }
    els.chkNoRepeat.checked = !!s.noRepeat;
    renderConfirmed(); clearCurrentUI(); updateDrawEnabled();
  }
  function handleIncoming(msg){
    switch(msg?.type){
      case 'snapshot': applySnapshot(msg.payload); break;
      case 'confirm': {
        const it = msg.payload; // { ...current, uid }
        if (!confirmed.find(x=>x.uid===it.uid)){ confirmed.push(it); renderConfirmed(); }
        break;
      }
      case 'delete': {
        const uid = msg.payload; const i = confirmed.findIndex(x=>x.uid===uid);
        if (i!==-1){ confirmed.splice(i,1); renderConfirmed(); }
        break;
      }
      case 'reset': {
        confirmed.splice(0); renderConfirmed(); clearCurrentUI(); seenPool.clear(); updateDrawEnabled();
        break;
      }
      case 'meta': {
        const m = msg.payload; // {topic, category, noRepeat}
        if (m.topic && DATA.topics[m.topic]){ els.topicSelect.value = m.topic; populateCategories(m.topic); }
        if (m.category && DATA.topics[m.topic]?.[m.category]){ els.categorySelect.value = m.category; }
        if (typeof m.noRepeat==='boolean'){ els.chkNoRepeat.checked = m.noRepeat; }
        updateDrawEnabled();
        break;
      }
    }
  }
  // 記錄目前已連線成員（含主持人自己）
const memberIds = new Set();

function updatePeerList(){
  elsNet.peerList.innerHTML = '';
  memberIds.forEach(id => {
    const li = document.createElement('li');
    li.textContent = id;
    elsNet.peerList.appendChild(li);
  });
}

  function setupAsHost(){
    peer = createPeer(elsNet.roomId.value.trim() || undefined);
    peer.on('open', id => {
  myId = id;
  memberIds.add(id); // 自己也加進成員清單
  updatePeerList();
  elsNet.myPeerId.textContent = id;
  elsNet.badge.style.display = 'block';
});
peer.on('connection', conn => {
  conns.add(conn);
  memberIds.add(conn.peer); // 記錄新成員
  updatePeerList();

  conn.on('close', ()=> {
    conns.delete(conn);
    memberIds.delete(conn.peer); // 移除斷線成員
    updatePeerList();
  });
      conn.on('data', (msg) => {
        if (msg?.type === 'hello'){ conn.send({ type:'snapshot', payload: getSnapshot() }); return; }
        handleIncoming(msg); // 自己先套用
        broadcast(msg);      // 再轉發給其他人
      });
      // 新加入就發快照
      conn.send({ type:'snapshot', payload: getSnapshot() });
    });
  }

  function setupAsGuest(){
    peer = createPeer();
    peer.on('open', id => {
      myId = id; elsNet.myPeerId.textContent = id; elsNet.badge.style.display = 'block';
      hostId = elsNet.roomId.value.trim();
      if (!hostId){ alert('請輸入主持人的房間ID'); return; }
      hostConn = peer.connect(hostId);
      hostConn.on('open', ()=> { hostConn.send({ type:'hello' }); }); // 請主持人給快照
      hostConn.on('data', (msg) => handleIncoming(msg));
    });
  }

  elsNet.btnJoin.addEventListener('click', ()=>{
    elsNet.btnJoin.disabled = true; elsNet.roomId.disabled = true; elsNet.isHost.disabled = true;
    if (elsNet.isHost.checked) setupAsHost(); else setupAsGuest();
  });

  // 把本機操作接上同步：全員互看
  els.btnConfirm.addEventListener('click', ()=>{
    setTimeout(()=>{
      const last = confirmed[confirmed.length-1]; if (!last) return;
      const msg = { type:'confirm', payload: last };
      if (elsNet.isHost.checked) broadcast(msg); else sendToHost(msg);
    }, 0);
  });

  els.confirmedGrid.addEventListener('click', (e)=>{
    const btn = e.target.closest('button.del'); if (!btn) return;
    const uid = btn.dataset.uid;
    setTimeout(()=>{
      const msg = { type:'delete', payload: uid };
      if (elsNet.isHost.checked) broadcast(msg); else sendToHost(msg);
    }, 0);
  });

  document.getElementById('btnReset').addEventListener('click', ()=>{
    setTimeout(()=>{
      const msg = { type:'reset' };
      if (elsNet.isHost.checked) broadcast(msg); else sendToHost(msg);
    }, 0);
  });

  // 可選：同步抽卡條件（主題/分類/是否不重複），避免彼此看到不同條件
  [els.topicSelect, els.categorySelect, els.chkNoRepeat].forEach(el=>{
    el.addEventListener('change', ()=>{
      const msg = { type:'meta', payload: {
        topic: els.topicSelect.value,
        category: els.categorySelect.value,
        noRepeat: els.chkNoRepeat.checked
      }};
      if (elsNet.isHost.checked) broadcast(msg); else sendToHost(msg);
    });
  });
  </script>
  <!-- =================== /PeerJS 同步補丁 =================== -->
</body>
</html>